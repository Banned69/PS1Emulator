#define GPU_COMMAND(x) \
    ((x >>> 24) & 0xff)

pseudo.CstrGraphics = function() {
    // Primitive Size
    const pSize = [
        0x00,0x01,0x03,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x04,0x04,0x04,0x04,0x07,0x07,0x07,0x07, 0x05,0x05,0x05,0x05,0x09,0x09,0x09,0x09,
        0x06,0x06,0x06,0x06,0x09,0x09,0x09,0x09, 0x08,0x08,0x08,0x08,0x0c,0x0c,0x0c,0x0c,
        0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00, 0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,
        0x04,0x04,0x04,0x04,0x00,0x00,0x00,0x00, 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0x03,0x03,0x03,0x03,0x04,0x04,0x04,0x04, 0x02,0x02,0x02,0x02,0x03,0x03,0x03,0x03,
        0x02,0x02,0x02,0x02,0x03,0x03,0x03,0x03, 0x02,0x02,0x02,0x02,0x03,0x03,0x03,0x03,
        0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    ];

    let status;

    // Command Pipeline
    const pipe = {
        data: new UintWcap(256)
    };

    const dataMem = {
        write(stream, addr, size) {
            let i = 0;
            let haha = 0;

            while (i < size) {
                haha = stream ? directMemW(mem.ram.uw, addr) : addr;
                addr += 4;
                i++;

                if (!pipe.size) {
                    const prim  = GPU_COMMAND(haha);
                    const count = pSize[prim];

                    if (count) {
                        pipe.data[0] = haha;
                        pipe.prim = prim;
                        pipe.size = count;
                        pipe.row  = 1;
                    }
                    else {
                        continue;
                    }
                }
                else {
                    pipe.data[pipe.row] = haha;
                    pipe.row++;
                }

                if (pipe.size === pipe.row) {
                    pipe.size = 0;
                    pipe.row  = 0;

                    render.draw(pipe.prim, pipe.data);
                }
            }
        }
    };

    // Exposed class functions/variables
    return {
        reset() {
            status = 0;

            // Command Pipe
            pipe.data.fill(0);
            pipe.prim = 0;
            pipe.size = 0;
            pipe.row  = 0;

            render.resize({ w: 320, h: 240 });
        },

        scopeW(addr, data) {
            switch(addr & 0xf) {
                case 0: // Data
                    dataMem.write(false, data, 1);
                    return;

                case 4: // Status
                    switch(GPU_COMMAND(data)) {
                        case 0x00:
                            status = 0x14802000;
                            return;

                        /* unused */
                        case 0x03:
                        case 0x04:
                        case 0x05:
                        case 0x06:
                        case 0x07:
                        case 0x08:
                            return;
                    }

                    psx.error('GPU Write Status ' + psx.hex(GPU_COMMAND(data)));
                    return;
            }
        },

        scopeR(addr) {
            switch(addr & 0xf) {
                case 0: // Data
                    return 0;

                case 4: // Status
                    return status;
            }
        },

        executeDMA(addr) {
            if (chcr === 0x01000401) {
                while(madr !== 0xffffff) {
                    const count = directMemW(mem.ram.uw, madr);
                    dataMem.write(true, madr + 4, count >>> 24);
                    madr = count & 0xffffff;
                }
                return;
            }
        }
    };
};

const vs = new pseudo.CstrGraphics();
