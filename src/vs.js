#define GPU_COMMAND(x) \
    ((x >>> 24) & 0xff)

pseudo.CstrGraphics = function() {
    // Primitive Size
    const pSize = [
        0x00,0x01,0x03,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x04,0x04,0x04,0x04,0x07,0x07,0x07,0x07, 0x05,0x05,0x05,0x05,0x09,0x09,0x09,0x09,
        0x06,0x06,0x06,0x06,0x09,0x09,0x09,0x09, 0x08,0x08,0x08,0x08,0x0c,0x0c,0x0c,0x0c,
        0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00, 0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,
        0x04,0x04,0x04,0x04,0x00,0x00,0x00,0x00, 0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
        0x03,0x03,0x03,0x03,0x04,0x04,0x04,0x04, 0x02,0x02,0x02,0x02,0x03,0x03,0x03,0x03,
        0x02,0x02,0x02,0x02,0x03,0x03,0x03,0x03, 0x02,0x02,0x02,0x02,0x03,0x03,0x03,0x03,
        0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    ];

    // Command Pipeline
    const pipe = {
        data: new UintWcap(256)
    };

    function writeData(addr) {
        if (!pipe.size) {
            const prim  = GPU_COMMAND(addr);
            const count = pSize[prim];

            if (count) {
                pipe.data[0] = addr;
                pipe.prim = prim;
                pipe.size = count;
                pipe.row  = 1;
            }
            else {
                return;
            }
        }
        else {
            pipe.data[pipe.row] = addr;
            pipe.row++;
        }

        if (pipe.size === pipe.row) {
            pipe.size = 0;
            pipe.row  = 0;

            render.draw(pipe.prim, pipe.data);
        }
    }

    return {
        writeData(addr) {
            if (!pipe.size) {
                const prim  = GPU_COMMAND(addr);
                const count = pSize[prim];
    
                if (count) {
                    pipe.data[0] = addr;
                    pipe.prim = prim;
                    pipe.size = count;
                    pipe.row  = 1;
                }
                else {
                    return;
                }
            }
            else {
                pipe.data[pipe.row] = addr;
                pipe.row++;
            }
    
            if (pipe.size === pipe.row) {
                pipe.size = 0;
                pipe.row  = 0;
    
                render.draw(pipe.prim, pipe.data);
            }
        },

        executeDMA(addr) {
            if (chcr === 0x01000401) {
                while(madr !== 0xffffff) {
                    const count = directMemW(mem.ram.uw, madr);
                    let haha = madr + 4;
                    let i = 0;
                    while (i < (count >>> 24)) {
                        writeData(directMemW(mem.ram.uw, haha));
                        haha += 4;
                        i++;
                    }
                    madr = count & 0xffffff;
                }
                return;
            }
        }
    };
};

const vs = new pseudo.CstrGraphics();
